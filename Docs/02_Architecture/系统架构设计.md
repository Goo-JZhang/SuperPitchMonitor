# SuperPitchMonitor 系统架构设计

## 1. 系统总体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SuperPitchMonitor Application                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │   UI Layer   │  │  Controller  │  │   Service    │  │  Analytics   │    │
│  │              │  │     Layer    │  │    Layer     │  │    Layer     │    │
│  │ - Spectrum   │  │ - App State  │  │ - Audio      │  │ - Logger     │    │
│  │   Display    │  │   Management │  │   Engine     │  │ - Metrics    │    │
│  │ - Pitch HUD  │  │ - Settings   │  │ - Detector   │  │ - Crash      │    │
│  │ - Settings   │  │   Controller │  │   Engine     │  │   Reporter   │    │
│  │   Panel      │  │ - Data Flow  │  │ - File I/O   │  │              │    │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────────────┘    │
│         │                 │                 │                               │
│         └─────────────────┴─────────────────┘                               │
│                           │                                                  │
│                    JUCE Application Framework                                │
│                           │                                                  │
└───────────────────────────┼──────────────────────────────────────────────────┘
                            │
┌───────────────────────────┼──────────────────────────────────────────────────┐
│                     Platform Abstraction Layer                               │
├───────────────────────────┼──────────────────────────────────────────────────┤
│  ┌────────────────────────┴────────────────────────┐  ┌──────────────────┐  │
│  │          Android Platform Layer                  │  │   iOS (Future)   │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐         │  │                  │  │
│  │  │ AAudio   │ │ OpenSL   │ │ Audio    │         │  │                  │  │
│  │  │ Backend  │ │ ES Fall  │ │ Record   │         │  │                  │  │
│  │  │          │ │ back     │ │ Permiss  │         │  │                  │  │
│  │  └──────────┘ └──────────┘ └──────────┘         │  │                  │  │
│  └─────────────────────────────────────────────────┘  └──────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 核心模块设计

### 2.1 音频引擎模块 (AudioEngine)

```cpp
namespace spm {

class AudioEngine : public AudioAppComponent,
                    private Thread
{
public:
    // 生命周期管理
    void prepareToPlay(int samplesPerBlock, double sampleRate) override;
    void releaseResources() override;
    void getNextAudioBlock(const AudioSourceChannelInfo& buffer) override;
    
    // 处理控制
    void startDetection();
    void stopDetection();
    void setInputConfig(InputConfig config);
    
    // 回调接口
    using SpectrumCallback = std::function<void(const SpectrumData&)>;
    using PitchCallback = std::function<void(const PitchVector&)>;
    
    void setSpectrumCallback(SpectrumCallback callback);
    void setPitchCallback(PitchCallback callback);
    
private:
    // 环形缓冲区用于异步处理
    AudioBufferFifo inputFifo_;
    
    // 处理链
    std::unique_ptr<Preprocessor> preprocessor_;
    std::unique_ptr<SpectrumAnalyzer> spectrumAnalyzer_;
    std::unique_ptr<PolyphonicDetector> pitchDetector_;
    
    // 处理线程
    void run() override; // Thread implementation
};

} // namespace spm
```

### 2.2 频谱分析模块 (SpectrumAnalyzer)

```cpp
class SpectrumAnalyzer
{
public:
    struct Config {
        int fftOrder = 12;           // 4096 samples
        int hopSize = 512;           // 87.5% overlap at 44.1kHz
        WindowType window = WindowType::Hann;
        bool zeroPad = true;
    };
    
    struct SpectrumData {
        std::vector<float> magnitude;   // 幅度谱
        std::vector<float> phase;       // 相位谱 (用于瞬时频率)
        float sampleRate;
        int frameIndex;
        juce::Time timestamp;
    };
    
    void process(const AudioBuffer<float>& input, SpectrumData& output);
    
private:
    dsp::FFT fft_;
    AudioBuffer<float> windowBuffer_;
    AudioBuffer<float> fftBuffer_;
    
    // 多分辨率支持
    std::vector<std::unique_ptr<dsp::FFT>> multiResolutionFFTs_;
};
```

### 2.3 多音高检测模块 (PolyphonicDetector)

```cpp
class PolyphonicDetector
{
public:
    struct Config {
        float minFrequency = 50.0f;    // 最低检测频率 (Hz)
        float maxFrequency = 2000.0f;  // 最高检测频率 (Hz)
        int maxPolyphony = 6;          // 最大同时检测音数
        float confidenceThreshold = 0.7f;
    };
    
    struct PitchCandidate {
        float frequency;      // 检测到的频率 (Hz)
        float midiNote;       // MIDI 音符编号 (带小数表示音分)
        float confidence;     // 置信度 0-1
        float amplitude;      // 相对幅度
        int harmonicCount;    // 检测到的谐波数量
    };
    
    using PitchVector = std::vector<PitchCandidate>;
    
    void detect(const SpectrumAnalyzer::SpectrumData& spectrum, 
                PitchVector& results);
    
private:
    // 子算法组件
    std::unique_ptr<PeakDetector> peakDetector_;
    std::unique_ptr<HarmonicClustering> harmonicClustering_;
    std::unique_ptr<NMFProcessor> nmfProcessor_;
    std::unique_ptr<PYINRefiner> pyinRefiner_;
    
    void extractPeaks(const std::vector<float>& magnitude,
                      std::vector<Peak>& peaks);
    void clusterHarmonics(const std::vector<Peak>& peaks,
                          PitchVector& candidates);
};
```

---

## 3. 数据处理流程

### 3.1 实时处理流水线

```
┌────────────────────────────────────────────────────────────────────────────┐
│                         实时音频处理流水线                                  │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  Audio Input ──┬──> 环形缓冲区 ──> 预处理 ──> FFT分析 ──┬──> 频谱显示    │
│     44.1kHz    │    (异步解耦)    降噪/加窗           │                │
│                │                                      │                │
│                │                                      └──> 多音高检测   │
│                │                                               │         │
│                │                                               ▼         │
│                │                                         峰值检测         │
│                │                                               │         │
│                │                                               ▼         │
│                │                                         谐波聚类         │
│                │                                               │         │
│                │                                               ▼         │
│                │                                         NMF分解          │
│                │                                               │         │
│                │                                               ▼         │
│                │                                         pYIN精修         │
│                │                                               │         │
│                │                                               ▼         │
│                │                                         时序平滑         │
│                │                                               │         │
│                └───────────────────────────────────────────────┘         │
│                                                                │         │
│                                                                ▼         │
│                                                         回调到UI线程      │
│                                                                │         │
│                                                                ▼         │
│                                                      音高显示/可视化       │
└────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 缓冲策略

```cpp
class AudioBufferFifo
{
public:
    // 双缓冲设计：前端(音频线程) -> FIFO -> 后端(处理线程)
    
    struct Buffer {
        static constexpr int size = 4096;  // 约 93ms @ 44.1kHz
        float samples[size];
        int numSamples;
        double timestamp;
    };
    
    // 音频线程调用 (非阻塞)
    bool push(const float* input, int numSamples);
    
    // 处理线程调用 (阻塞/非阻塞可选)
    bool pop(Buffer& output, bool blocking = true);
    
private:
    AbstractFifo fifo_;
    HeapBlock<Buffer> buffers_;
    std::atomic<int> writeIndex_{0};
    std::atomic<int> readIndex_{0};
};
```

---

## 4. 线程模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           线程架构                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    音频回调线程 (高优先级)                            │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │  AAudio      │  │  数据拷贝    │  │  写入FIFO    │              │   │
│  │  │  Callback    │  │  到本地缓冲  │  │  (无锁)      │              │   │
│  │  │  ~5ms周期    │  │              │  │              │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    音频处理线程 (中优先级)                            │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │  从FIFO读取  │  │  FFT + 检测  │  │  回调结果    │              │   │
│  │  │  ~23ms周期   │  │  算法处理    │  │  到MessageTh │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    UI线程 (主线程)                                    │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │  接收结果    │  │  更新可视化  │  │  渲染OpenGL  │              │   │
│  │  │  回调        │  │  状态        │  │  或软件渲染  │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 模块依赖关系

```
UI Layer (juce_gui_basics, juce_gui_extra)
    │
    ├──> Controller Layer
    │       │
    │       └──> Service Layer
    │               │
    │               ├──> AudioEngine (juce_audio_devices)
    │               │       │
    │               │       ├──> SpectrumAnalyzer (juce_dsp)
    │               │       │       │
    │               │       │       └──> FFT (juce_dsp)
    │               │       │
    │               │       └──> PolyphonicDetector
    │               │               │
    │               │               ├──> PeakDetector
    │               │               ├──> HarmonicClustering
    │               │               ├──> NMFProcessor
    │               │               └──> PYINRefiner
    │               │
    │               └──> File I/O (juce_audio_formats)
    │
    └──> Analytics (可选模块)

Base: juce_core, juce_events, juce_data_structures
```

---

## 6. Android 特定适配

### 6.1 音频路由策略

```cpp
class AndroidAudioManager
{
public:
    // 自动选择最佳音频API
    void initializeBestBackend();
    
    // AAudio 配置 (Android 8.0+)
    struct AAudioConfig {
        aaudio_performance_mode_t performanceMode = AAUDIO_PERFORMANCE_MODE_LOW_LATENCY;
        aaudio_sharing_mode_t sharingMode = AAUDIO_SHARING_MODE_EXCLUSIVE;
        int32_t bufferCapacity = 0;  // 0 = auto
    };
    
    // OpenSL ES 回退配置
    struct OpenSLConfig {
        int bufferCount = 2;
        int bufferSize = 512;
    };
    
    // 音频焦点管理
    void requestAudioFocus();
    void abandonAudioFocus();
    
    // 设备变更监听
    void onAudioDeviceChanged(AudioDeviceType newDevice);
    
private:
    bool useAAudio_;
    std::unique_ptr<AAudioStream> aaudioStream_;
    std::unique_ptr<OpenSLStream> openslStream_;
};
```

### 6.2 权限与生命周期

```
Android Activity 生命周期:
    onCreate()  ──> 初始化 JUCE Application
        │
    onResume()  ──> 请求音频权限 ──> 启动 AudioEngine
        │                              │
    onPause()   <─────────────────────┘
        │
    onStop()    ──> 暂停检测 (可选后台模式)
        │
    onDestroy() ──> 释放 AudioEngine 资源
```

---

## 7. 配置文件结构

```yaml
# config.yaml
audio:
  sample_rate: 44100
  buffer_size: 512
  input_channels: 1
  
detection:
  min_frequency: 50.0      # Hz
  max_frequency: 2000.0    # Hz
  max_polyphony: 6
  confidence_threshold: 0.7
  
analysis:
  fft_order: 12            # 4096 samples
  hop_size: 512
  window_type: "hann"
  multi_resolution: true
  
performance:
  target_latency_ms: 10
  adaptive_quality: true   # 根据设备性能自动调整
  power_save_mode: false
  
ui:
  spectrum_bands: 128
  update_rate_hz: 60
  color_scheme: "dark"
  show_octave: true
  show_cents: true
```
