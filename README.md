# SuperPitchMonitor

A real-time polyphonic pitch detection and visualization application based on the JUCE framework. Supports multi-resolution spectral analysis for accurate pitch detection across the full frequency range.

## Features

- **Machine Learning Pitch Detection** (NEW): Neural network-based pitch detection using ONNX Runtime
  - Dual-output: Confidence (基频概率) + Energy (强度)
  - GPU acceleration: CoreML (macOS), CUDA (Windows), NNAPI (Android)
  - 4096 samples input → 2048 frequency bins output (20-5000Hz)
  - ML/FFT mode toggle at runtime
  
- **Real-time Pitch Detection**: Monophonic and polyphonic pitch detection
- **Multi-resolution Analysis**: Adaptive FFT resolution for different frequency bands
- **Cross-platform**: Windows, macOS, Linux, Android, iOS
- **Visual Feedback**: 
  - Spectrum display (ML模式: 双纵轴 Confidence/Energy | FFT模式: dB频谱)
  - Pitch waterfall (历史音高散点图)
  - Pitch cards (音名 + cents偏差 + 强度)
- **Test Framework**: Python-based automated testing with FFT reference analysis

## Quick Start

### One-Click Setup

Choose your platform and build type:

#### Windows

```powershell
# Release build (default)
cd scripts\build
build_windows.bat

# Debug build
build_windows.bat Debug

# Custom build directory
build_windows.bat Release build-custom
```

#### macOS

```bash
# Release build (default)
cd scripts/build
chmod +x build_macos.sh
./build_macos.sh

# Debug build
./build_macos.sh Debug

# Custom build directory
./build_macos.sh Release build-custom
```

#### Linux

```bash
# Release build (default)
cd scripts/build
chmod +x build_linux.sh
./build_linux.sh

# Debug build
./build_linux.sh Debug

# Custom build directory
./build_linux.sh Release build-custom
```

## Manual Build Guide

### Prerequisites

- CMake 3.15+
- C++17 compatible compiler
- Python 3.7+ (for generating test audio)
- Git

**Note:** 
- JUCE framework will be downloaded automatically by CMake during the first build
- Downloaded dependencies are cached in `ThirdParty/` directory (not committed to git)
- Once cached, you can build offline without internet connection

### Step 1: Clone Repository

```bash
git clone https://github.com/yourusername/SuperPitchMonitor.git
cd SuperPitchMonitor
```

### Step 2: Generate Test Audio Files

Test audio files are generated by Python scripts and **not** included in the repository.

```bash
# Install Python dependencies
pip install numpy scipy

# Generate all test audio (10-second files for 0.1Hz FFT resolution)
python scripts/audio/generate_all_tests.py
```

This will create audio files in `Resources/TestAudio/`.

### Step 3: Build

**Note:** First build will download JUCE automatically (requires internet connection).

#### Windows (Visual Studio)

```bash
mkdir build-windows && cd build-windows
cmake .. -G "Visual Studio 17 2022" -A x64
# First build: JUCE will be downloaded automatically
cmake --build . --config Release
```

#### macOS (Xcode)

```bash
mkdir build-macos && cd build-macos
cmake .. -G Xcode -DCMAKE_BUILD_TYPE=Release
# First build: JUCE will be downloaded automatically
cmake --build . --config Release
```

#### Linux (Makefile)

```bash
mkdir build-linux && cd build-linux
cmake .. -DCMAKE_BUILD_TYPE=Release
# First build: JUCE will be downloaded automatically
cmake --build . -j$(nproc)
```

#### Android

See [Android Build Guide](Docs/07_Build/BuildGuide.md)

### ML Build Options

```bash
# Option 1: Build ONNX Runtime from source (recommended for macOS CoreML)
# - Full operator support, includes Split, Resize, etc.
# - Takes 20-30 minutes (similar to JUCE first build)
# - Enables CoreML/CUDA/DirectML GPU acceleration
cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_ONNXRUNTIME_FROM_SOURCE=ON

# Option 2: Use pre-built ONNX Runtime (faster, ~1 min)
# - Limited operator support, may not work with all models
cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_ONNXRUNTIME_FROM_SOURCE=OFF
```

## Project Structure

```
SuperPitchMonitor/
├── CMakeLists.txt              # Main CMake configuration
├── LICENSE                     # GPLv3 License
├── README.md                   # This file
│
├── Source/                     # Source code
│   ├── Audio/                 # Audio processing (pitch detection, spectrum)
│   ├── UI/                    # User interface components
│   ├── Test/                  # Automated testing framework
│   └── Utils/                 # Utilities (logger, config)
│
├── Resources/                  # Resources
│   └── TestAudio/             # Test audio files (generated, not in git)
│
├── scripts/                    # Scripts organized by category
│   ├── audio/                 # Audio generation scripts
│   ├── build/                 # Build setup scripts
│   ├── test/                  # Test and analysis scripts
│   └── utils/                 # Utility scripts
│
├── Docs/                       # Documentation
│   ├── 01_TechnicalAnalysis/  # Technical analysis
│   ├── 02_Architecture/       # Architecture docs
│   ├── 06_Development/        # Development guides
│   └── ...                    # Other documentation
│
├── scripts/                    # Build and utility scripts
│   ├── build/                 # Cross-platform build scripts
│   │   ├── build_macos.sh     # macOS build script
│   │   ├── build_windows.bat  # Windows build script
│   │   ├── build_linux.sh     # Linux build script
│   │   └── README.md          # Build documentation
│   ├── test/                  # Test scripts
│   └── audio/                 # Audio generation scripts
│
├── ThirdParty/                 # External dependencies cache (downloaded by CMake)
│   └── juce-src/              # JUCE framework (auto-downloaded)
│
├── Saved/                      # Runtime generated data (not in git)
│   └── Logs/                  # Application runtime logs
│
└── build-*/                    # Build directories (platform-specific, generated)
    └── build_*.log            # Build logs (for debugging build failures)
```

## Testing

### Automated Testing (Cross-Platform)

The project uses a unified TCP-based testing framework that works on Windows, macOS, and Linux.

```bash
# Generate test audio (if not already done)
python scripts/audio/generate_all_tests.py

# Run all tests
python scripts/test/test_client.py

# Run specific test category
python scripts/test/test_client.py --test single_tone

# Run with custom parameters
python scripts/test/test_client.py --test sine_440 --wait-frames 100
```

### Test Framework Architecture

**TestServer (C++ side)**
- Runs inside the application (both GUI and headless modes)
- Listens on TCP port 9999 (configurable)
- Commands: `getStatus`, `setMultiRes`, `loadFile`, `startPlayback`, `stopPlayback`, `getPitches`, `waitForFrames`

**TestClient (Python side)**
- Cross-platform: works on Windows, macOS, Linux
- Communicates via TCP socket (no platform-specific dependencies)
- Validates results against ground truth data

### Test Modes

**Normal Mode** (GUI with TestServer enabled):
```bash
# Windows
./SuperPitchMonitor.exe

# macOS
./SuperPitchMonitor.app/Contents/MacOS/SuperPitchMonitor

# Linux
./SuperPitchMonitor
```

**Test Mode** (Headless, TestServer only):
```bash
# Windows
./SuperPitchMonitor.exe -TestMode -TestPort 9999

# macOS
./SuperPitchMonitor.app/Contents/MacOS/SuperPitchMonitor -TestMode -TestPort 9999

# Linux
./SuperPitchMonitor -TestMode -TestPort 9999
```

### Test Framework Features

- **Cross-platform**: Single Python test script works on all platforms
- **TCP-based communication**: No platform-specific dependencies (replaces Windows named pipes)
- **Ground truth validation**: Compares detected pitches against FFT-calculated reference data
- **Per-frame analysis**: Frequency, confidence, amplitude statistics
- **Multi-resolution testing**: Tests both MR-ON and MR-OFF modes

## Key Algorithms

- **Multi-resolution FFT**: Different FFT sizes for low/mid/high frequencies
- **YIN Pitch Detection**: Time-domain periodicity analysis
- **Harmonic Analysis**: Separates fundamentals from harmonics
- **Polyphonic Separation**: Identifies multiple simultaneous pitches

## Documentation

See the `Docs/` directory for:
- [Technical Analysis](Docs/01_TechnicalAnalysis/) - Algorithm details
- [Architecture](Docs/02_Architecture/) - System design
- [Build Guides](Docs/07_Build/) - Platform-specific instructions

## License

This project is licensed under the **GNU General Public License v3.0 (GPLv3)**.

This software uses the [JUCE](https://juce.com/) framework, which is also licensed under GPLv3 (with commercial licensing alternatives available).

See [LICENSE](LICENSE) file for details.

### Commercial Licensing

If you need to use this software in a closed-source commercial product, you must:
1. Purchase a JUCE commercial license from Raw Material Software
2. Contact the author for a commercial license to this software

## Development Notes

### Recent Architecture Changes

#### Testing Framework (v2.0)

The testing framework has been unified to support all platforms:

**Before (Windows only):**
- Named pipes (`\\.\pipe\SPM_TestPipe`)
- Required `pywin32` dependency
- `-AutoTest` command line parameter

**After (Cross-platform):**
- TCP sockets (`127.0.0.1:9999`)
- Pure Python standard library
- `-TestMode` command line parameter

**Migration:**
```bash
# Old way (Windows)
python scripts/test/test_client_with_fft.py --file sine_440hz.wav

# New way (All platforms)
python scripts/test/test_client.py --test sine_440
```

See [Test Framework Documentation](Docs/06_Development/Test_Framework_Architecture.md) for details.

### Cross-platform Considerations

- **Line endings**: Repository uses LF (Unix-style). Configure Git:
  ```bash
  git config core.autocrlf true  # Windows
  git config core.autocrlf input # macOS/Linux
  ```

- **Build directories**: Use platform-specific prefixes:
  - `build-windows/` - Windows builds
  - `build-macos/` - macOS builds
  - `build-linux/` - Linux builds

- **Test audio**: Always run `scripts/audio/generate_all_tests.py` after cloning to generate test files

### Git Workflow

```bash
# After cloning
git clone https://github.com/username/SuperPitchMonitor.git
cd SuperPitchMonitor

# Generate test audio
python scripts/audio/generate_all_tests.py

# Make changes...

# Commit and push
git add .
git commit -m "Description of changes"
git push origin main
```

## Directory Structure

### Generated Files and Directories (not in Git)

| Directory/File | Purpose | Persistence |
|----------------|---------|-------------|
| `SuperPitchMonitor` / `SuperPitchMonitor.exe` / `SuperPitchMonitor.app` | Main executable | ❌ Rebuilt on each compile |
| `ThirdParty/` | External dependencies (JUCE, etc.) | ✅ Persistent |
| `Saved/Logs/` | Application runtime logs | ✅ Persistent |
| `build-*/` | Build intermediates and logs | ❌ Can be deleted |
| `Resources/TestAudio/` | Generated test audio files | ✅ Persistent |

### Logs Location

- **Runtime Logs**: `Saved/Logs/*.log` - Application execution logs
- **Build Logs**: `build-*/build_*.log` - CMake and compilation logs (useful for debugging build failures)

### Executable Output

The compiled executable is placed directly in the project root directory for easy access:

**Windows:**
- `SuperPitchMonitor.exe` - Main executable

**macOS:**
- `SuperPitchMonitor.app/` - macOS app bundle (run with `open SuperPitchMonitor.app` or `./SuperPitchMonitor.app/Contents/MacOS/SuperPitchMonitor`)

**Linux:**
- `SuperPitchMonitor` - Main executable

### Test Mode vs Normal Mode

| Mode | Description | Use Case |
|------|-------------|----------|
| Normal Mode | Full GUI with TestServer enabled | Interactive use and development |
| Test Mode | Headless, TestServer only | Automated testing via Python scripts |

**Start in Test Mode:**
```bash
./SuperPitchMonitor -TestMode -TestPort 9999
```

## Troubleshooting

### CMake not found
- **Windows**: Install from https://cmake.org/download/
- **macOS**: `brew install cmake`
- **Linux**: `sudo apt-get install cmake`

### Python dependencies missing
```bash
pip install numpy scipy
```

### Test audio not found
```bash
# Regenerate test audio
python scripts/audio/generate_all_tests.py
```

## Contact

[Your Contact Information]
